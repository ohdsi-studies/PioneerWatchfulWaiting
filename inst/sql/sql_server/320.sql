CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (35960740,36726633,36726634,36726635,36726636,36726637,36726638,36726639,36726640,36726641,36726642,36726643,36726968,36726644,36726645,36726646,36726647,36726648,36726649,36726650,36726965,36726966,36726967,36726969,36726970,36726971,36726972,36726973,36726974,36726975,36726976,36726977,36726978,36726979,36726980,36726981,36726982,36726983,36726984,36726985,36726986,36726987,36726988,36726989,36726990,36726991,36726992,36726993,36726994,36726995,36726996,36726997,36726998,36726999,36727000,36727001,36727002,36726224,36726225,36726226,36726227,36726228,36726229,36726230,36726231,36726232,36726233,36726234,36726235,36726236,36726237,36726238,36726239,36726240,36726241,36726242,36726243,36726244,36726245,36726246,36726247,36726248,36726249,36726250,36726251,36726252,36726253,36726254,36726255,36726256,36726257,36726258,36726259,36726260,36726261,36726262,36726263,36726264,36726265,36726266,36726267,36726268,36726269,36726270,36726271,36726272,36726273,36726274,36726275,36726276,36726705,36726706,36726707,36726708,36726709,36726710,36726711,36726712,36726713,36726714,36726715,36726716,36726717,36726718,36726719,36726720,36726721,36726722,36726723,36726724,36726726,36726727,36726728,36726729,36726730,36726731,36726732,36726733,36726734,36726735,36726736,36726737,36726738,36726739,36726740,36726741,36726742,36726743,36726744,3011543,35950928,3031258,36728321,36728322,36728323,36728324,36727834,36727835,36727836,36727837,36727838,36727839,36727840,36727841,36727842,36727844,36727612,36727613,36727614,36727615,36727616,36727617,36727618,36727619,36727620,36727621,36727622,36727623,36727624,36727625,36727626,36727845,36727672,36727673,36727846,36727847,36727848,36727849,36727850,36727852,36727851,36727853,36727854,36728059,36728060,36728061,36728062,36728063,36728064,36728065,36728066,36728067,36728068,36728071,36728069,36728070,36728075,36728072,36728073,36728074,36728076,36728077,36728078,36728079,36728080,36728081,36728082,36728083,36728084,36728085,36728086,36728087,36728088,36728089,36728090,36728091,36728092,36728093,36728094,36728095,36728096,36728097,36728098,36728099,36728100,36728101,36728102,36728103,36728104,3000360,4135410,3020720,3005580,3182152,35950178,36728105,36728106,36728107,36728108,36728109,36728110,36728111,36728112,36728113,36728114,36727827,36727828,36727829,36727830,36727831,36728115,36728116,36728117,36728119,36728118,36728121,36728120,36728122,36728123,36728124,36728125,36728126,36728127,36728128,36728129,36728130,36728131,36728132,36728133,36728134,36728135,36728136,36728139,36728140,36728141,36728142,36728143,36728144,36728145,36728146,36728147,36728148,36728149,36728150,36728151,36728152,36728153,36727855,36727856,36727857,36727858,36727859,36727860,36727861,36727862,36727863,36727864,36727865,36727866,36727867,36727868,36727869,36727870,36727871,36727872,36727873,36727874,36727875,36727876,36727877,36727878,36727879,36727880,36727881,36727882,36727883,36727884,36727885,36727886,36728054,36728055,36728056,36728057,36728058,36728154,36728155,36728156,36728157,36728158,36728159,36728160,36728161,36728162,36728163,36728164,36728165,36728166,36728167,36728168,36728169,36728170,36728171,36728172,36728173,36728174,36728175,36728176,36728177,36728178,36728196,36728197,36728198,36728199,36728200,36728201,36728202,36728203,36728204,36728205,36728206,36728207,36728208,36728209,36728210,36728211,36728212,36728213,36728214,36728215,36728541,36728542,36728543,36728544,36728545,36728546,36728547,36728548,36728549,36728550,36728551,36728552,36728553,36728554,36728555,36728556,36728557,36728558,36728559,36728560,36728561,36728562,36728563,36728564,36728565,36728566,36728567,36728568,36728569,36728570,36728571,36728572,36728573,36728574,36728575,36728576,36728577,36728578,36728579,36728580,36728581,36728582,36728583,36728584,36728585,36728586,36728587,36728588,36728589,36728590,36728591,36728592,36728593,36728594,36728216,36728419,36728420,36728421,36728422,36728423,36728424,36728425,36728426,36728427,36728428,36728429,36728430,36728431,36728432,36728433,36728434,36728435,36728436,36728438,36728440,36728441,36728439,36728442,36728443,36728444,36728445,36728446,3014662,4135411,3048642,35948105,36730210,36730211,36730212,36730213,36730214,36730215,36730216,36730217,36730218,36730219,36730220,36730143,36730144,36730145,36730245,36730246,36730247,36730248,36730249,36730250,36729210,36729211,36729212,36729213,36729219,36729220,36729221,36729223,36729226,36729227,36729228,36729231,36729232,36729235,36729236,36729459,36729237,36729239,36729242,36729243,36729244,36729246,36729247,36729439,36729441,36729444,36729447,36729448,36729455,36729462,36729463,36729466,36729497,36729500,36729501,36729510,36729512,36729515,36730260,36730261,36730268,36730679,36730686,36730689,36730692,36730703,36730727,36730733,36730747,36730750,36730244,36730146,36730147,36730148,36730149,36730150,36730151,36730152,36730153,36730154,36730155,36730156,36730157,36730158,36730159,36730160,36730161,36730162,36729655,36729656,36729657,36729658,36729659,36729660,36729661,36729662,36729663,36729664,36729665,36729666,36729667,36729668,36729669,36729670,36729671,36729672,36729673,36729674,36729675,36729676,36729677,36729678,36729679,36729680,36729681,36729682,36729683,36729685,36729686,36729687,36729688,36729689,36729690,36729691,36729692,36729693,36729694,36729695,36729696,36729697,36730221,36730222,36730223,36730224,36730225,36729601,36729602,36729603,36729604,36729605,36729606,36729607,36729608,36729609,36729610,36729611,36729612,36729613,36729953,36729954,36729955,36729956,36729957,36729958,36729959,36729960,36729961,36729962,36729963,36729964,36729965,36729966,36729967,36729968,36729969,36729970,36729971,36729972,36729981,36729973,36729974,36729975,36729976,36729977,36729978,36729979,36729980,36729982,36729983,36729984,36729986,36729987,36729988,36729989,36729990,36729991,36729992,36729993,36729994,36729995,36729996,36729997,36729998,36729999,36730000,36730001,36730002,36730003,36730004,36730005,36730006,36730442,36730443,36730444,36730445,36730446,36730447,36730448,36730449,36730450,36730451,36730452,36730453,36730454,36730455,36730456,36730457,36730458,36730459,36730460,36730461,36730008,36730009,36730010,36730011,36730012,36730013,36730014,36730015,36730016,36730017,36730018,36730019,36730020,36730021,36730022,36730023,36730024,36730025,36730026,36730027,36730028,36730029,36730030,36730031,36730032,36730033,36730034,36730035,36730036,36730037,36730038,36730039,36730040,36730041,36730042,36730043,36730044,36730045,36730046,36730047,36730048,36730050,36730051,36730052,36730053,36730054,36730055,36730056,36730057,36730058,36730059,36730060,36730226,36730227,36730228,36730230,36730229,36730231,36730232,36730233,36730234,36730235,36730236,36730237,36730238,36730239,36730240,36730241,36730242,36730243,36729214,36729215,36729216,36729217,36729218,36729222,36729224,36729225,36729229,36729230,36729233,36729234,36729238,36729241,36729240,36729245,36729248,36729440,36729442,36729443,36729445,36729446,36729449,36729450,36729451,36729452,36729453,36729454,36729456,36729457,36729458,36729460,36729461,36729464,36729465,36729492,36729467,36729468,36729469,36729470,36729471,36729472,36729473,36729474,36729475,36729476,36729477,36729478,36729479,36729480,36729481,36729482,36729483,36729484,36729485,36729486,36729487,36729488,36729489,36729490,36729491,36729493,36729494,36729495,36729496,36729498,36729499,36729502,36729503,36729504,36729505,36729506,36729507,36729508,36729509,36729511,36729513,36729514,36729516,36730251,36730252,36730253,36730254,36730264,36730265,36730255,36730258,36730259,36730262,36730263,36730266,36730267,36730269,36730377,36730378,36730379,36730380,36730381,36730382,36730383,36730384,36730386,36730387,36730678,36730680,36730681,36730682,36730683,36730684,36730685,36730687,36730688,36730690,36730691,36730693,36730694,36730695,36730696,36730697,36730698,36730699,36730700,36730701,36730702,36730704,36730710,36730705,36730706,36730707,36730708,36730709,36730711,36730712,36730713,36730714,36730715,36730716,36730718,36730719,36730720,36730721,36730722,36730724,36730723,36730725,36730726,36730728,36730729,36730730,36730731,36730732,36730734,36730735,36730736,36730737,36730738,36730739,36730740,36730741,36730742,36730743,36730744,36730745,36730746,36730748,36730749,36730752,36730751,36730753,36730754,36730755,36730756,36730757,36730758,36730388,36730389,36730390,36730391,36730392,36730393,36730394,36730395,36730396,36730397,36730398,36730399,36730400,36730401,36730402,36730403,36730404,36730405,36730406,36730407,36730408,36730414,36730409,36730410,36730411,36730412,36730413,36730415,36730416,36730419,36730417,36730418,36730420,36730421,36730422,36730423,36730424,36730425,36730426,36730427,36730428,36730430,36730431,36730432,36730433,36730434,36730435,36730436,36730437,36730438,36730439,36730440,36730441,36730462,36730463,36730464,36730465,36730466,36730467,36730468,36730469,36730470,36729614,36729615,43055145,37039510,3173094,3184282,21493968,21493970,36755357,36755358,3169584,35946800,35977059,35977060,36767954,36768000,36768002,36768041,36759064,36759127,36758726,36758728,36767906,36767908,36767921,36767935,36767945,36758727,36758729,36758730,36758731,36758732,36758733,36758734,36758735,36758736,36758737,36758738,36758739,36758740,36758741,36758742,36758743,36758744,36758745,36758746,36758747,36758748,36758749,36758750,36758751,36758752,36758753,36758754,36758755,36758756,36758757,36758758,36758759,36758760,36758761,36758762,36758763,36758764,36758765,36758766,36758767,36758768,36758769,36758770,36758771,36758772,36758773,36758774,36758775,36758776,36758777,36758778,36758779,36758780,36758021,36758022,36758023,36758024,36758025,36758026,36758027,36758028,36758029,36758030,36758031,36758032,36758033,36758034,36758035,36758037,36758036,36758038,36758039,36758040,36758041,36758042,36758043,36758046,36758048,36758049,36758050,36758422,36758424,36758427,36758428,36758435,36758439,36758440,36758442,36758443,36758444,36758447,36758452,36758454,36758456,36758458,36758461,36758462,36758465,36758469,36758472,36758474,36758479,36758476,36758784,36758410,36758389,36758406,36758407,36758408,36758409,36758411,36758412,36758413,36758414,36758415,36758416,36758418,36758502,36758510,36758517,36758528,36758548,36758551,36758559,36758565,36758570,36758576,36758577,36758583,36758598,36758607,36758281,36758628,36758633,36758870,36758891,36758893,36758894,36758899,36758900,36758901,36758904,36758909,36758906,36758907,36758908,36758910,36758911,36758912,36758913,36758914,36758919,36758920,36758921,36758922,36758925,36758926,36758924,36758928,36758929,36758930,36758932,36758933,36758934,36758939,36758941,36758942,36758945,36758946,36758947,36758948,36758949,36758944,36758952,36758953,36758954,36758956,36758957,36758955,36758958,36758959,36758960,36758972,36758962,36758963,36758964,36758966,36758968,36758971,36758973,36758974,36758975,36758976,36758977,36759307,36758979,36758980,36758981,36758982,36758983,36759305,36759315,36759308,36759309,36759310,36759311,36759313,36759314,36759316,36759317,36759319,36759320,36759321,36758804,36759322,36758805,36758806,36758807,36758808,36758809,36758810,36758814,36758815,36759323,36759325,36759328,36759329,36759330,36759331,36759332,36759341,36759333,36759334,36759335,36759337,36759338,36759339,36759340,36759342,36759343,36759345,36759124,36759125,36759128,36759129,36759134,36759135,36759136,36759137,36759153,36759138,36759139,36759140,36759141,36759143,36759144,36759145,36759146,36759147,36759148,36759149,36759150,36759151,36759152,36759166,36759155,36759156,36759158,36759159,36759160,36759161,36759162,36759163,36759164,36759167,36759168,36759169,36759170,36759171,36759173,36759174,36759176,36759177,36759179,36759180,36759183,36759185,36759188,36759190,36759192,36759193,36759194,36759195,36759196,36759197,36759198,36759199,36759200,36759201,36759202,36759203,36759204,36759205,36759206,36759216,36759208,36759210,36759213,36759214,36759215,36759226,36759217,36759218,36759219,36759220,36759221,36759222,36759224,36759225,36759227,36759228,36759229,36759233,36759234,36759235,36759236,36759237,36759238,36759239,36759241,36759243,36759244,36759247,36759248,36759249,36759574,36759577,36759579,36759580,36759581,36759583,36759584,36759586,36759587,36759589,36759602,36759594,36759595,36759599,36759601,36759603,36759604,36759605,36759609,36759610,36759611,36759612,36759613,36759616,36759625,36759618,36759619,36759620,36759621,36759622,36759623,36759624,36759626,36759629,36758636,36758638,36758639,36758642,36758644,36758645,36758646,36758647,36758649,36758650,36758651,36758652,36758653,36758654,36758656,36758657,36758658,36758660,36759038,36759039,36759041,36759042,36759043,36759049,36759047,36759051,36759052,36759053,36759054,36759055,36759056,36759057,36759062,36759063,36759066,36759068,36759070,36759072,36759073,36759074,36759076,36759083,36758663,36759087,36758667,36758672,36758678,36758680,36758681,36758683,36758684,36758685,36758688,36758690,36758691,36758692,36758695,36758700,36758701,36758702,36758703,36758712,36758704,36758705,36758706,36758707,36758708,36758711,36758713,36758822,36758824,36758826,36758827,36758829,36758830,36758831,36758832,36758834,36758836,36758838,36758840,36758841,36758842,36758843,36758467,36758044,36758045,36758047,36758051,36758423,36758425,36758426,36758430,36758431,36758432,36758433,36758434,36758436,36758437,36758438,36758441,36758445,36758446,36758448,36758449,36758450,36758451,36758453,36758455,36758457,36758459,36758460,36758463,36758464,36758466,36758468,36758470,36758473,36758475,36758477,36758478,36758480,36758481,36758482,36758483,36758781,36758782,36758783,36758785,36758786,36758787,36758788,36758789,36758380,36758373,36758790,36758791,36758792,36758793,36758794,36758795,36758796,36758797,36758798,36758799,36758800,36758368,36758801,36758802,36758803,36758820,36758821,36758369,36758370,36758371,36758372,36758374,36758375,36758376,36758377,36758378,36758379,36758381,36758383,36758382,36758388,36758384,36758385,36758386,36758387,36758390,36758391,36758392,36758393,36758394,36758395,36758396,36758397,36758398,36758399,36758401,36758402,36758403,36758404,36758405,36758417,36758421,36758419,36758420,36758499,36758500,36758501,36758503,36758504,36758505,36758506,36758507,36758508,36758511,36758509,36758513,36758512,36758514,36758515,36758518,36758516,36758520,36758521,36758522,36758523,36758524,36758525,36758526,36758527,36758547,36758529,36758530,36758531,36758532,36758533,36758534,36758535,36758536,36758537,36758538,36758539,36758540,36758541,36758542,36758543,36758544,36758545,36758546,36758549,36758550,36758552,36758553,36758554,36758555,36758556,36758557,36758558,36758560,36758562,36758563,36758564,36758566,36758567,36758568,36758569,36758571,36758572,36758573,36758574,36758575,36758578,36758579,36758580,36758581,36758582,36758584,36758585,36758586,36758587,36758588,36758589,36758590,36758595,36758591,36758592,36758593,36758594,36758596,36758597,36758599,36758600,36758601,36758602,36758604,36758605,36758606,36758610,36758608,36758609,36758611,36758612,36758613,36758614,36758615,36758616,36758617,36758249,36758250,36758251,36758252,36758254,36758255,36758256,36758257,36758258,36758259,36758260,36758261,36758262,36758263,36758264,36758265,36758266,36758267,36758268,36758269,36758270,36758271,36758272,36758273,36758274,36758275,36758276,36758280,36758277,36758278,36758279,36758282,36758287,36758283,36758284,36758285,36758286,36758288,36758289,36758290,36758291,36758292,36758293,36758294,36758295,36758296,36758297,36758298,36758299,36758618,36758619,36758620,36758621,36758622,36758623,36758624,36758625,36758626,36758627,36758629,36758630,36758631,36758632,36758634,36758635,36758845,36758846,36758847,36758848,36758849,36758850,36758851,36758852,36758853,36758854,36758858,36758859,36758860,36758861,36758862,36758863,36758864,36758865,36758866,36758867,36758868,36758855,36758856,36758857,36758869,36758871,36758872,36758873,36758874,36758875,36758876,36758877,36758878,36758879,36758880,36758881,36758882,36758883,36758884,36758885,36758886,36758888,36758889,36758887,36758890,36758892,36758895,36758896,36758897,36758898,36758905,36758902,36758903,36758916,36758915,36758917,36758918,36758931,36758923,36758927,36758935,36758936,36758937,36758938,36758940,36758943,36758950,36758951,36758961,36758965,36758967,36758969,36758970,36758978,36759304,36759306,36759312,36759318,36758811,36758812,36758813,36758816,36758817,36758818,36758819,36759324,36759326,36759327,36759336,36759133,36759344,36759126,36759130,36759131,36759132,36759142,36759165,36759154,36759157,36759172,36759175,36759178,36759184,36759181,36759182,36759186,36759187,36759189,36759191,36759207,36759209,36759211,36759212,36759223,36759230,36759231,36759232,36759240,36759242,36759245,36759246,36759570,36759571,36759572,36759573,36759575,36759578,36759576,36759582,36759585,36759588,36759590,36759591,36759592,36759593,36759596,36759597,36759598,36759600,36759607,36759608,36759606,36759614,36759617,36758640,36759627,36759628,36759630,36758637,36758641,36758643,36758648,36758655,36758659,36759040,36759045,36759044,36759046,36759048,36759050,36759058,36759059,36759060,36759061,36759065,36759067,36759069,36759071,36759075,36759077,36759078,36759079,36759080,36759081,36759082,36759084,36759085,36759086,36758661,36758662,36758664,36758665,36758666,36759631,36758668,36758669,36758670,36758671,36758676,36758677,36758673,36758674,36758675,36758679,36758682,36758686,36758687,36758689,36758693,36758694,36758696,36758697,36758698,36758699,36758709,36758710,36758714,36758823,36758825,36758837,36758828,36758833,36758835,36758839,36758844,3175819,40761517,3039791,3175629,3181216,3045422,40761114,35950588,35977063,36760027,36760028,36760029,36760032,36760030,36760031,36760033,36760034,36760035,36760036,36760037,36760038,36760039,36759656,36759657,36759658,36759659,36759660,36759661,36759662,36759663,36759664,36759665,36759666,36759667,36759668,36759669,36759670,36759671,36759672,36759673,36759674,36759675,36759676,36759677,36759678,36759679,36759680,36759681,36759682,36759683,36759684,36759685,36759687,36759686,36759688,36759689,36759690,36759691,36759692,36759693,36759694,36759695,36759696,36759697,36759698,36759699,36759700,36759701,36759702,36759703,36759704,36759705,36759706,36759707,36759708,36759709,36759710,36759711,36759712,36759713,36760046,36759714,36759715,36759716,36759717,36759718,36759719,36759720,36759251,36759250,36759252,36759253,36759254,36759255,36759256,36759257,36759258,36759259,36759260,36759261,36759263,36759262,36760040,36760041,36760042,36760043,36760044,36760045,36760047,36760048,36760049,36760050,36760051,36760052,36760053,36760054,36760055,36760056,36760057,36760058,36760110,36760111,36760112,36760113,36760114,36760115,36760116,36760117,36760118,36760121,36760119,36760120,36760122,36760123,36760124,36760125,36759518,36759519,36760126,36759516,36759517,36759520,36759521,36759522,36759523,36759524,36759525,36759526,36759527,36759528,36759529,36759530,36759531,36759532,36759533,36759534,36759535,36759536,36759537,36759538,36759539,36759540,36759541,36759542,36759543,36759544,36759545,36759546,36759547,36759548,36759549,36759550,36759551,36759552,36759553,36759554,36759555,36759556,36759557,36759558,36759564,36759559,36759560,36759561,36759562,36759563,36759565,36759566,36759567,36759568,36759722,36759569,36759721,36759723,36759752,36759724,36759725,36759726,36759727,36759728,36759729,36759730,36759731,36759732,36759733,36759734,36759735,36759736,36759737,36759738,36759739,36759740,36759744,36759741,36759742,36759743,36759745,36759746,36759747,36759748,36759749,36759750,36759751,36759753,36759754,36759755,36759756,36759757,36759758,36759759,36759760,36759761,36759762,36759763,36759764,36759765,36759766,36759767,36759768,36759769,36759770,36759771,36759772,36759773,36759774,36759775,36759776,36759777,36759778,36759779,36759780,36759781,36759782,36759783,36759784,36759785,36759436,36759786,36759787,36759434,36759435,36759437,36759438,36759439,36759440,36759441,36759442,36759443,36759444,36759445,36759446,36759447,36759448,36759449,36759496,36759454,36759450,36759451,36759452,36759455,36759456,36759461,36759457,36759458,36759459,36759460,36759462,36759463,36759464,36759465,36759468,36759466,36759467,36759469,36759470,36759471,36759472,36759473,36759474,36759475,36759476,36759477,36759478,36759479,36759485,36759484,36759480,36759481,36759482,36759483,36759488,36759486,36759487,36759489,36759490,36759491,36759492,36759493,36759494,36759495,36759497,36759498,36759499,36759500,36759501,36759502,36759503,36759504,36759505,36759506,36759507,36759508,36759509,36759510,36759511,36759512,36759513,36759514,36759515,36760749,36760750,36760751,36760752,36760753,36760754,36760755,36760756,36760757,36760758,36760759,36760760,36760761,36760762,36760763,36760764,36760765,36760774,36760766,36760767,36760768,36760769,36760770,36760771,36760772,36760773,36760775,36760776,36760777,36760778,36760779,36760780,36760781,36760782,36760783,36760784,36760785,36760786,36760787,36760788,36760789,36760790,36760791,36760796,36760797,36759799,36759853,36760851,36760375,36760377,36760379,36760380,36760381,36760382,36760383,36760093,36760094,36760386,36760396,36760402,36760465,36760469,36760475,36760481,36760483,36760486,36760488,36760489,36760493,36760494,36760505,36760511,36760792,36760793,36760794,36760795,36760798,36760799,36760800,36760801,36760802,36760803,36760804,36760805,36760806,36760809,36760807,36760808,36759788,36759789,36759790,36759791,36759792,36759793,36759794,36759795,36759796,36759797,36759798,36759800,36759801,36759807,36759808,36759809,36759810,36759811,36759812,36759813,36759814,36759815,36759816,36759818,36759819,36759820,36759821,36759822,36759823,36759824,36759825,36759826,36759827,36759828,36759829,36759830,36759831,36759832,36759833,36759842,36759834,36759835,36759836,36759837,36759838,36759839,36759841,36759840,36759843,36759844,36759845,36759846,36759847,36759848,36759849,36759850,36759851,36759852,36759854,36759855,36759856,36759857,36759858,36759860,36759863,36759861,36759862,36759864,36759865,36759866,36759867,36759868,36759869,36759870,36759871,36759872,36759873,36759874,36759875,36759876,36759877,36759878,36759879,36759880,36759881,36759882,36760818,36760819,36760820,36760821,36760822,36760823,36760824,36760825,36760826,36760827,36760828,36760829,36760830,36760831,36760832,36760833,36760835,36760837,36760834,36760836,36760838,36760839,36760840,36760841,36760842,36760843,36760844,36760845,36760846,36760847,36760848,36760849,36760850,36760343,36760344,36760345,36760346,36760347,36760348,36760349,36760350,36760351,36760352,36760353,36760354,36760355,36760356,36760357,36760358,36760359,36760360,36760361,36760362,36760364,36760363,36760365,36760366,36760367,36760369,36760370,36760371,36760372,36760373,36760374,36760376,36760378,36760059,36760060,36760061,36760062,36760063,36760065,36760069,36760066,36760067,36760068,36760070,36760071,36760072,36760073,36760074,36760075,36760076,36760077,36760078,36760079,36760080,36760081,36760082,36760083,36760084,36760085,36760086,36760087,36760088,36760089,36760090,36760091,36760092,36760095,36760096,36760097,36760098,36760099,36760100,36760101,36760103,36760102,36760104,36760105,36760106,36760107,36760108,36760109,36760384,36760385,36760387,36760388,36760389,36760390,36760391,36760392,36760393,36760397,36760394,36760395,36760398,36760399,36760400,36760401,36760466,36760467,36760468,36760470,36760471,36760472,36760473,36760474,36760476,36760477,36760478,36760479,36760480,36760482,36760484,36760485,36760487,36760499,36760490,36760491,36760492,36760495,36760496,36760497,36760498,36760500,36760501,36760502,36760503,36760504,36760507,36760506,36760508,36760509,36760510,36760512,36760513,36760514,36760515,36760516,36760517,36760518,36760519,36760520,36760521,36760522,36760523,36760524,36760525,36760526,36760527,36760528,36760529,36760530,36760531,36760532,36759883,36759884,36759885,36759886,3188610,3040727,3185487,35949597,3184178,3177250,35983610,35983604,35983611,35983605,35983606,35983612,35983613,35983607,35983608,35983609,35983614,35983615,35983616,35983617,35983618,35983619,35983620,35983621,35983622,35983623,35983624,35983625,35983626,35983627,35983628,35983629,35983630,35983631,35983632,35983633,35983634,35983635,35983636,35983637,35983638,35983639,35983640,35983641,35983642,35983643,35983644,35983645,35983646,35983647,35983648,35983649,35983650,35983651,35983652,35983654,35983655,35983656,35983657,35983658,35983659,35983660,35983661,35983662,35983663,35983664,35983665,35983666,35983667,35983668,35983669,35983670,35983671,35983672,35983673,35983674,35983675,35983676,35983677,35983678,35983679,35983680,35983681,35983682,35983683,35983684,35983685,35983686,35983687,35983688,35983689,35983690,35983691,35983692,35983693,35983694,35983695,35983696,35983697,35983698,35983699,35983700,35983701,35983702,35983703,35983704,35983705,35983706,35983707,35983708,35983709,35983710,35983711,35983712,35983713,35983714,35983715,35983716,35983717,35983718,35983719,35983720,35983721,35983722,35983723,35983724,35983725,35983726,35983727,35983728,35983729,35983730,35983731,35983732,35983733,35983734,35983735,35983736,35983737,35983738,35983740,35983739,35983744,35983741,35983742,35983743,35983745,35983746,35983747,35983748,35983749,35983750,35983751,35983752,35983753,35983754,35983755,35983756,35983757,35983758,35983759,35983760,35983761,35983762,35983763,35983764,35983765,35983766,35983767,35983768,35983769,35983770,35983771,35983772,35983773,35983774,35983775,35983776,35983777,35983778,35983779,35983780,35983781,35983782,35983783,35983784,35983785,35983786,35983787,35983788,35983789,35983790,35983791,35983792,35983793,35983794,35983795,35983796,35983797,35983798,35983799,35983800,35983801,35983802,35983803,35983804,35983805,35983806,35983807,35983808,35983809,35983810,35983811,35983812,35983813,35983814,35983815,35983816,35984524,35984525,35984489,35984490,35984491,35984492,35984493,35984494,35984495,35984496,35984497,35984498,35984499,35984500,35984501,35984502,35984503,35984504,35984505,35984506,35984507,35984508,35984509,35984510,35984511,35984512,35984513,35984514,35984515,35984518,35984516,35984517,35984519,35984520,35984521,35984522,35984523,35984526,35984528,35984529,35984527,35984530,35984531,35984532,35984533,35984534,35984535,35984537,35984536,35984538,35984539,35984540,35984541,35984542,35984543,35984544,35984545,35984546,35984547,35984548,35984551,35984552,35984553,35984549,35984550,35984554,35984555,35984556,35984557,35984564,35984568,35984566,35984567,35984565,35984558,35984559,35984560,35984561,35984562,35984563,35984569,35984570,35984571,35984572,35984573,35984574,35984575,35984576,35984577,35984587,35984578,35984579,35984580,35984581,35984582,35984583,35984584,35984585,35984586,35984588,35984589,35984590,35984591,35984592,35984593,35984594,35984595,35984596,35984597,35984598,35984599,35984600,35984602,35984601,35984603,35984604,35984605,35984606,35984607,35984608,35984609,35984610,35984611,35984612,35984613,35984614,35984615,35984616,35984617,35984618,35984619,35984620,35984621,35984622,35984623,35984624,35984625,35984626,35984627,35984695,35984696,35984628,35984629,35984630,35984631,35984632,35984633,35984634,35984635,35984636,35984637,35984642,35984638,35984639,35984640,35984641,35984643,35984644,35984645,35984646,35984647,35984648,35984649,35984650,35984651,35984652,35984653,35984654,35984655,35984656,35984657,35984658,35984659,35984660,35984661,35984662,35984663,35984664,35984665,35984667,35984666,35984668,35984669,35984671,35984670,35984672,35984673,35984674,35984679,35984675,35984676,35984677,35984678,35984680,35984681,35984683,35984682,35984684,35984685,35984687,35984688,35984686,35984689,35984690,35984691,35984692,35984693,35984694,35984697,35984698,35984699,35984700,35984703,35984701,35984702,35984704,35984705,35984706,35984707,35984708,35984709,35984710,35984711,35984712,35984713,35984714,35984715,35984716,35984717,35984718,35984719,35984720,35984721,35984722,35984723,35984724,35984725,35984726,35984727,35984728,35984729,35984730,35984731,35984732,35984733,35984734,35984735,35984736,35984737,35984738,35984739,35984759,35984740,35984741,35984742,35984743,35984744,35984745,35984746,35984747,35984748,35984749,35984750,35984751,35984752,35984753,35984754,35984755,35984756,35984757,35984758,35984760,35984761,35984762,35984763,35984764,35984765,35984766,35984767,35984768,35984769,35984770,35984771,35984772,35984773,35984774,35984775,35984776,35984777,35984778,35984779,35984780,35984781,35984782,35984783,35984784,35984785,35984809,35984786,35984787,35984788,35984789,35984790,35984791,35984792,35984793,35984794,35984795,35984796,35984797,35984798,35984799,35984800,35984801,35984802,35984803,35984804,35984805,35984806,35984807,35984808,35984810,35984811,35984812,35984813,35984814,35984815,35984816,35984817,35984818,35984819,35984820,35984821,35984822,35984823,35984824,35984826,35984825,35984827,35984828,35984829,35984830,35984831,35984832,35984833,35984834,35984835,35984836,35984837,35984838,35984839,35984840,35984841,35984842,35984843,35984844,35984845,35984846,35984847,35984848,35984849,35984850,35984851,35984852,35984853,35984864,35984865,35984854,35984855,35984857,35984856,35984858,35984859,35984863,35984860,35984861,35984862,35984866,35984867,35984868,35984869,35984870,35984871,35984872,35984873,35984874,35984875,35984876,35984877,35984878,35984879,35984880,35984881,35984882,35984883,35984884,35984885,35984886,35984887,35984888,35984889,35984890,35984891,35984892,35984893,35984894,35984895,35984896,35984897,35984898,35984899,35984900,35984901,35984902,35984903,35984904,35984905,35984906,35984909,35984907,35984908,35984915,35984910,35984911,35984912,35984913,35984914,35984916,35984917,35984927,35984918,35984919,35984928,35984929,35984920,35984921,35984922,35984923,35984930,35984931,35984932,35984924,35984925,35984926,35984933,35984934,35984935,35984969,35984936,35984937,35984938,35984939,35984940,35984941,35984942,35984943,35984944,35984945,35984946,35984947,35984948,35984949,35984950,35984951,35984952,35984953,35984954,35984955,35984956,35984957,35984975,35984958,35984959,35984960,35984961,35984962,35984968,35984963,35984964,35984965,35984966,35984967,35984970,35984971,35984972,35984973,35984974,35984990,35984976,35984977,35984978,35984979,35984981,35984980,35984982,35984983,35984984,35984985,35984986,35984987,35984988,35984989,35984991,35984992,35984993,35984994,35984995,35984996,35984997,35984998,35984999,35985000,35985001,35985002,35985003,35985004,35985005,35985006,35985007,35985008,35985009,35985010,35985011,35985012,35985015,35985013,35985016,35985017,35985018,35985019,35985020,35985021,35985022,35985023,35985024,35985025,35985026,35985027,35985028,35985029,35985030,35985031,35985032,35985033,35985034,35985035,35985036,35985037,35985038,35985039,35985040,35985041,35985042,35985043,35985044,35985045,35985046,35985047,35985048,35985049,35985050,35985051,35985052,35985053,35985054,35985055,35985057,35985058,35985059,35985060,35985061,35985062,35985063,35985064,35985065,35985066,35985069,35985067,35985068,35985070,35985071,35985072,35985073,35985074,35985075,35985076,35985077,35985078,35985079,35985080,35985081,35985082,35985083,35985084,35985085,35985086,35985087,35985088,35985089,35985090,35985091,35985092,35985093,35985094,35985095,35985096,35985097,35985112,35985098,35985099,35985100,35985101,35985102,35985103,35985104,35985105,35985106,35985109,35985107,35985108,35985110,35985111,35985113,35985114,35985115,35985116,35985117,35985118,35985119,35985120,35985121,35985122,35985123,35985124,35985125,35985126,35985127,35985128,35985129,35985130,35985131,35985132,35985133,35985134,35985135,35985136,35985137,35985138,35985139,35985140,35985141,35985142,35985143,35985144,35985145,35985146,35985147,35985148,35985149,35985150,35985151,35985152,35985153,35985154,35985155,35985156,35985157,35985158,35985159,35985160,35985161,35985162,35985163,35985164,35985165,35985166,35985167,35985168,35985169,35985170,35985171,35985172,35985173,35985174,35985175,35985176,35985177,35985178,35985179,35985180,35985181,35985182,35985183,35985184,35985185,35985188,35985186,35985187,35985189,35985190,35985191,35985192,35985193,35985194,35985195,35985196,35985197,35985198,35985199,35985200,35985201,35985202,35985203,35985204,35985927,35985928,35985929,35985930,35985931,35985932,35985933,35985934,35985935,35985936,35985937,35985938,35985939,35985940,35985941,35985942,35985943,35985944,35985945,35985946,35985947,35985948,35985949,35985950,35985951,35985952,35985953,35985954,35985955,35985956,35985957,35985958,35985959,35985960,35985961,35985962,35985963,35985964,35985965,35985966,35985967,35985968,35985969,35985981,35985970,35985971,35985972,35985973,35985974,35985975,35985976,35985977,35985979,35985978,35985980,35985982,35985983,35985984,35985985,35985986,35985987,35985988,35985989,35985990,35985991,35985992,35985993,35985994,35985995,35985996,35985997,35985998,35985999,35986000,35986001,35986002,35986003,35986004,35986005,35986006,35986007,35986008,35986009,35986010,35986011,35986012,35986013,35986014,35986015,35986016,35986017,35986018,35986019,35986020,35986021,35986022,35986023,35986024,35986025,35986026,35986027,35986028,35986029,35986030,35986031,35986032,35986033,35986034,35986035,35986036,35986037,35986038,35986039,35986041,35986040,35986042,35986043,35986044,35986045,35986056,35986046,35986047,35986048,35986049,35986052,35986050,35986051,35986053,35986054,35986055,35986057,35986058,35986059,35986060,35986061,35986062,35986063,35986064,35986065,35986066,35986067,35986068,35986069,35986070,35986071,35986072,35990072,35990073,35990079,35990074,35990080,35990081,35990082,35990083,35990075,35990076,35990084,35990077,35990078,35990085,35990086,35990134,35990087,35990088,35990089,35990090,35990091,35990093,35990092,35990094,35990095,35990096,35990097,35990098,35990099,35990100,35990101,35990102,35990103,35990104,35990107,35990105,35990106,35990108,35990109,35990110,35990111,35990112,35990113,35990114,35990115,35990116,35990117,35990118,35990119,35990120,35990121,35990124,35990122,35990123,35990125,35990126,35990127,35990128,35990129,35990130,35990131,35990132,35990133,35990135,35990136,35990137,35990138,35990139,35990140,35990141,35990144,35990142,35990143,35990145,35990146,35990147,35990148,35990149,35990150,35990151,35990152,35990153,35990154,35990155,35990156,35990157,35990158,35990159,35990160,35990161,35990162,35990163,35990164,35990165,35990166,35990167,35990170,35990168,35990169,35990171,35990172,35990173,35990174,35990175,35990176,35990177,35990178,35990179,35990180,35990181,35990182,35990183,35990184,35990185,35990186,35990187,35990188,35990189,35990190,35990422,35990423,35990424,35990425,35990426,35990427,35990428,35990429,35990430,35990431,35990432,35990433,35990434,35990435,35990436,35990437,35990438,35990439,35990440,35990441,35990442,35990443,35990444,35990445,35990446,35990447,35990448,35990449,35990450,35990451,35990452,35990453,35990454,35990455,35990456,35990457,35990466,35990458,35990459,35990460,35990461,35990462,35990463,35990464,35990465,35990467,35990468,35990469,35990470,35990471,35990472,35990473,35990474,35990475,35990476,35990477,35990478,35990479,35990480,35990481,35990482,35990483,35990484,35990485,35990486,35990487,35990488,35990489,35990490,35990491,35990492,35990493,35990494,35990495,35990496,35990497,35990498,35990499,35990500,35990501,35990502,35990503,35990504,35990505,35990506,35990507,35990508,35990509,35990510,35990511,35990512,35990513,35990514,35990515,35990516,35990517,35990518,35990519,35990520,35990521,35990522,35990523,35990524,35990525,35990526,35990527,35990528,35990529,35990530,35990531,35990532,35990533,35990534,35990535,35990536,35990537,35990538,35990539,35990540,35990541,35990542,35990543,35990544,35990545,35990546,35990547,35990548,35990549,35990550,35990551,35990553,35990552,35990554,35990555,35990556,35990557,35990558,35990559,35990560,35990561,35990562,35990563,35990564,35990565,35990566,35990567,35990568,35990569,35990570,35990571,35990572,35990573,35990574,35990575,35990576,35990577,35990578,35990579,35990580,35990581,35990582,35990583,35990584,35990585,35990586,35990587,35990588,35990589,35990590,35990591,35990592,35990593,35990594,35990595,35990596,35990597,35990598,35990599,35990600,35990601,35990602,35990603,35990604,35990605,35990606,35990607,35990608,35990609,35990610,35990611,35990612,35990613,35990614,35990615,35990616,35990617,35990618,35990619,35990620,35990621,35990622,35990623,35990624,35990625,35990626,35990627,35990628,35990629,35990630,35990631,35990632,35990633,35990634,35990635,35990636,35990637,35990638,35990639,35990640,35990641,35990642,35990643,35990644,35990645,35990646,35990647,35990648,35990649,35990650,35990651,35990652,35990653,35990656,35990655,35990654,35990657,35990658,35990659,35990660,35990661,35990662,35990663,35990664,35990665,35990666,35990667,35990668,35990669,35990670,35990671,35990672,35990673,35990674,35990675,35990676,35990677,35990678,35990679,35990680,35990681,35990682,35952916)

) I
) C;


with primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id) as
(
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Measurement Criteria
select C.person_id, C.measurement_id as event_id, C.measurement_date as start_date, DATEADD(d,1,C.measurement_date) as END_DATE,
       C.measurement_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.measurement_date as sort_date
from 
(
  select m.* 
  FROM @cdm_database_schema.MEASUREMENT m
JOIN #Codesets codesets on ((m.measurement_concept_id = codesets.concept_id and codesets.codeset_id = 0))
) C


-- End Measurement Criteria

UNION ALL
-- Begin Condition Occurrence Criteria
SELECT C.person_id, C.condition_occurrence_id as event_id, C.condition_start_date as start_date, COALESCE(C.condition_end_date, DATEADD(day,1,C.condition_start_date)) as end_date,
       C.CONDITION_CONCEPT_ID as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.condition_start_date as sort_date
FROM 
(
  SELECT co.* 
  FROM @cdm_database_schema.CONDITION_OCCURRENCE co
  JOIN #Codesets codesets on ((co.condition_concept_id = codesets.concept_id and codesets.codeset_id = 0))
) C


-- End Condition Occurrence Criteria

UNION ALL
-- Begin Observation Criteria
select C.person_id, C.observation_id as event_id, C.observation_date as start_date, DATEADD(d,1,C.observation_date) as END_DATE,
       C.observation_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.observation_date as sort_date
from 
(
  select o.* 
  FROM @cdm_database_schema.OBSERVATION o
JOIN #Codesets codesets on ((o.observation_concept_id = codesets.concept_id and codesets.codeset_id = 0))
) C


-- End Observation Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P
WHERE P.ordinal = 1
-- End Primary Events

)
SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

with cteIncludedEvents(event_id, person_id, start_date, end_date, op_start_date, op_end_date, ordinal) as
(
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

)
select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM cteIncludedEvents Results
WHERE Results.ordinal = 1
;



-- generate cohort periods into #final_cohort
with cohort_ends (event_id, person_id, end_date) as
(
	-- cohort exit dates
  -- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
),
first_ends (person_id, start_date, end_date) as
(
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, E.end_date, row_number() over (partition by I.person_id, I.event_id order by E.end_date) as ordinal 
	  from #included_events I
	  join cohort_ends E on I.event_id = E.event_id and I.person_id = E.person_id and E.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
)
select person_id, start_date, end_date
INTO #cohort_rows
from first_ends;

with cteEndDates (person_id, end_date) AS -- the magic
(	
	SELECT
		person_id
		, DATEADD(day,-1 * 0, event_date)  as end_date
	FROM
	(
		SELECT
			person_id
			, event_date
			, event_type
			, MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal 
			, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type) AS overall_ord
		FROM
		(
			SELECT
				person_id
				, start_date AS event_date
				, -1 AS event_type
				, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
			FROM #cohort_rows
		
			UNION ALL
		

			SELECT
				person_id
				, DATEADD(day,0,end_date) as end_date
				, 1 AS event_type
				, NULL
			FROM #cohort_rows
		) RAWDATA
	) e
	WHERE (2 * e.start_ordinal) - e.overall_ord = 0
),
cteEnds (person_id, start_date, end_date) AS
(
	SELECT
		 c.person_id
		, c.start_date
		, MIN(e.end_date) AS end_date
	FROM #cohort_rows c
	JOIN cteEndDates e ON c.person_id = e.person_id AND e.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
)
select person_id, min(start_date) as start_date, end_date
into #final_cohort
from cteEnds
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;





TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;
